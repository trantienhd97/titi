<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Danh sách Sản phẩm</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 0; }
        .container { max-width: 800px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 30px; }
        h2 { color: #17a2b8; text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #17a2b8; color: #fff; }
        tr:nth-child(even) { background: #f9f9f9; }
        .back-btn { margin-bottom: 20px; background: #4285f4; color: #fff; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <button class="back-btn" onclick="window.history.back()">Quay lại</button>
        <h2>Danh sách Sản phẩm</h2>
        <input type="text" id="searchInput" placeholder="Tìm kiếm theo tên hoặc mã sản phẩm..." style="width: 100%; padding: 8px; margin-bottom: 16px; border-radius: 4px; border: 1px solid #ccc;">
        <table id="productTable">
            <thead>
                <tr>
                    <th>Tên sản phẩm</th>
                    <th>Mã</th>
                    <th>Giá nhập</th>
                    <th>Giá bán</th>
                    <th>% Giảm giá</th>
                    <th>Tiền giảm giá</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody>
                <!-- Dữ liệu sản phẩm sẽ được thêm ở đây -->
            </tbody>
        </table>
    </div>
    <div id="deleteConfirmModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#fff; padding:24px 32px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.2); min-width:300px; text-align:center;">
            <p style="font-size:18px; margin-bottom:20px;">Bạn có chắc chắn muốn xoá sản phẩm này?</p>
            <button id="confirmDeleteBtn" style="background:#db4437; color:#fff; padding:8px 20px; border:none; border-radius:4px; margin-right:10px;">Có</button>
            <button id="cancelDeleteBtn" style="background:#757575; color:#fff; padding:8px 20px; border:none; border-radius:4px;">Không</button>
        </div>
    </div>
    <script>
    let allProducts = [];
    let editingIndex = -1;
    let deleteIndex = -1;
    async function fetchProducts() {
        try {
            const { ipcRenderer } = require('electron');
            const response = await ipcRenderer.invoke('get-products');
            if (response.success) {
                allProducts = response.products;
                renderProducts(allProducts);
            } else {
                alert(response.message || 'Không thể lấy danh sách sản phẩm!');
            }
        } catch (e) {
            document.querySelector('#productTable tbody').innerHTML = '<tr><td colspan="7">Lỗi khi lấy dữ liệu sản phẩm!</td></tr>';
        }
    }
    function renderProducts(products) {
        const tbody = document.querySelector('#productTable tbody');
        tbody.innerHTML = '';
        if (!products || products.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7">Không có sản phẩm nào.</td></tr>';
            return;
        }
        products.forEach((product, idx) => {
            const tr = document.createElement('tr');
            if (editingIndex === idx) {
                tr.innerHTML = `
                    <td><input value="${product.name || ''}" id="editName" style="width:100%"></td>
                    <td><input value="${product.code || ''}" id="editCode" style="width:100%"></td>
                    <td><input type="number" value="${product.importPrice || ''}" id="editImportPrice" style="width:100%"></td>
                    <td><input type="number" value="${product.salePrice || ''}" id="editSalePrice" style="width:100%"></td>
                    <td><input type="number" value="${product.discountPercent || ''}" id="editDiscountPercent" style="width:100%"></td>
                    <td><input type="number" value="${product.discountAmount || ''}" id="editDiscountAmount" style="width:100%"></td>
                    <td>
                        <button onclick="saveEdit(${idx})">Lưu</button>
                        <button onclick="cancelEdit()">Huỷ</button>
                    </td>
                `;
            } else {
                tr.innerHTML = `
                    <td>${product.name || ''}</td>
                    <td>${product.code || ''}</td>
                    <td>${product.importPrice || ''}</td>
                    <td>${product.salePrice || ''}</td>
                    <td>${product.discountPercent || ''}</td>
                    <td>${product.discountAmount || ''}</td>
                    <td>
                        <button onclick="editProduct(${idx})">Sửa</button>
                        <button onclick="deleteProduct(${idx})">Xoá</button>
                    </td>
                `;
            }
            tbody.appendChild(tr);
        });
    }
    window.editProduct = function(idx) {
        editingIndex = idx;
        renderProducts(filterProducts(document.getElementById('searchInput').value));
    }
    window.cancelEdit = function() {
        editingIndex = -1;
        renderProducts(filterProducts(document.getElementById('searchInput').value));
    }
    window.saveEdit = async function(idx) {
        const { ipcRenderer } = require('electron');
        const product = allProducts[idx];
        const discountAmountValue = parseFloat(document.getElementById('editDiscountAmount').value);
        const updated = {
            ...product,
            name: document.getElementById('editName').value,
            code: document.getElementById('editCode').value,
            importPrice: parseFloat(document.getElementById('editImportPrice').value),
            salePrice: parseFloat(document.getElementById('editSalePrice').value),
            discountPercent: parseFloat(document.getElementById('editDiscountPercent').value),
            discountAmount: isNaN(discountAmountValue) ? 0 : discountAmountValue
        };
        const response = await ipcRenderer.invoke('update-product', updated);
        if (response.success) {
            allProducts[idx] = updated;
            editingIndex = -1;
            renderProducts(filterProducts(document.getElementById('searchInput').value));
        } else {
            alert(response.message || 'Cập nhật thất bại!');
        }
    }
    window.deleteProduct = function(idx) {
        deleteIndex = idx;
        document.getElementById('deleteConfirmModal').style.display = 'flex';
    }
    document.getElementById('cancelDeleteBtn').onclick = function() {
        document.getElementById('deleteConfirmModal').style.display = 'none';
        deleteIndex = -1;
    }
    document.getElementById('confirmDeleteBtn').onclick = async function() {
        if (deleteIndex === -1) return;
        const { ipcRenderer } = require('electron');
        const product = allProducts[deleteIndex];
        const response = await ipcRenderer.invoke('delete-product', product.id);
        if (response.success) {
            allProducts.splice(deleteIndex, 1);
            renderProducts(filterProducts(document.getElementById('searchInput').value));
        } else {
            alert(response.message || 'Xoá thất bại!');
        }
        document.getElementById('deleteConfirmModal').style.display = 'none';
        deleteIndex = -1;
    }
    function filterProducts(keyword) {
        if (!keyword) return allProducts;
        const lower = keyword.toLowerCase();
        return allProducts.filter(p => (p.name || '').toLowerCase().includes(lower) || (p.code || '').toLowerCase().includes(lower));
    }
    document.getElementById('searchInput').addEventListener('input', function() {
        renderProducts(filterProducts(this.value));
    });
    fetchProducts();
    </script>
</body>
</html>
