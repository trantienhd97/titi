<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Danh sách Sản phẩm</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f5f7fa; margin: 0; padding: 0; }
        .container { max-width: 1000px; margin: 40px auto; background: #fff; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); padding: 36px 40px; }
        h2 { color: #17a2b8; text-align: center; letter-spacing: 1px; }
        #searchInput { width: 100%; padding: 12px; margin-bottom: 24px; border-radius: 8px; border: 1px solid #d1d5db; font-size: 16px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 20px; background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        th, td { padding: 14px 10px; text-align: center; font-size: 15px; }
        th { background: #17a2b8; color: #fff; font-weight: 600; letter-spacing: 0.5px; }
        tr { transition: background 0.2s; }
        tr:hover { background: #f1f8fb; }
        td img.thumbnail { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); background: #f3f3f3; }
        .action-btn { padding: 6px 16px; border: none; border-radius: 6px; margin: 0 2px; font-size: 14px; cursor: pointer; transition: background 0.2s; }
        .action-btn.edit { background: #f4b400; color: #fff; }
        .action-btn.edit:hover { background: #e09c00; }
        .action-btn.delete { background: #db4437; color: #fff; }
        .action-btn.delete:hover { background: #b93125; }
        .action-btn.save { background: #28a745; color: #fff; }
        .action-btn.save:hover { background: #218838; }
        .action-btn.cancel { background: #757575; color: #fff; }
        .action-btn.cancel:hover { background: #616161; }
    </style>
</head>
<body>
    <div class="container">
        <button class="back-btn" onclick="window.history.back()">Quay lại</button>
        <h2>Danh sách Sản phẩm</h2>
        <input type="text" id="searchInput" placeholder="Tìm kiếm theo tên hoặc mã sản phẩm..." style="width: 100%; padding: 8px; margin-bottom: 16px; border-radius: 4px; border: 1px solid #ccc;">
        <table id="productTable">
            <thead>
                <tr>
                    <th>Ảnh</th>
                    <th>Tên sản phẩm</th>
                    <th>Mã</th>
                    <th>Giá nhập</th>
                    <th>Giá bán</th>
                    <th>% Giảm giá</th>
                    <th>Tiền giảm giá</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody>
                <!-- Dữ liệu sản phẩm sẽ được thêm ở đây -->
            </tbody>
        </table>
    </div>
    <div id="deleteConfirmModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#fff; padding:24px 32px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.2); min-width:300px; text-align:center;">
            <p style="font-size:18px; margin-bottom:20px;">Bạn có chắc chắn muốn xoá sản phẩm này?</p>
            <button id="confirmDeleteBtn" style="background:#db4437; color:#fff; padding:8px 20px; border:none; border-radius:4px; margin-right:10px;">Có</button>
            <button id="cancelDeleteBtn" style="background:#757575; color:#fff; padding:8px 20px; border:none; border-radius:4px;">Không</button>
        </div>
    </div>
    <script>
    let allProducts = [];
    let editingIndex = -1;
    let deleteIndex = -1;
    async function fetchProducts() {
        try {
            const { ipcRenderer } = require('electron');
            const response = await ipcRenderer.invoke('get-products');
            if (response.success) {
                allProducts = response.products;
                renderProducts(allProducts);
            } else {
                alert(response.message || 'Không thể lấy danh sách sản phẩm!');
            }
        } catch (e) {
            document.querySelector('#productTable tbody').innerHTML = '<tr><td colspan="7">Lỗi khi lấy dữ liệu sản phẩm!</td></tr>';
        }
    }
    function renderProducts(products) {
        const tbody = document.querySelector('#productTable tbody');
        tbody.innerHTML = '';
        if (!products || products.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8">Không có sản phẩm nào.</td></tr>';
            return;
        }
        products.forEach((product, idx) => {
            const tr = document.createElement('tr');
            const thumbnail = product.thumbnail && product.thumbnail.trim() !== '' ? product.thumbnail : 'https://via.placeholder.com/60x60?text=No+Image';
            tr.style.cursor = 'pointer';
            tr.onclick = function(e) {
                // Nếu click vào nút Sửa/Xoá thì không chuyển trang
                if (e.target.closest('button')) return;
                window.location.href = `product-detail.html?id=${encodeURIComponent(product.id)}`;
            };
            if (editingIndex === idx) {
                tr.innerHTML = `
                    <td>
                        <img src="${thumbnail}" class="thumbnail" alt="Ảnh sản phẩm" id="previewImg${idx}"><br>
                        <input type="file" id="editThumbnail${idx}" accept="image/*" style="margin-top:6px;">
                    </td>
                    <td><input value="${product.name || ''}" id="editName" style="width:100%"></td>
                    <td><input value="${product.code || ''}" id="editCode" style="width:100%"></td>
                    <td><input type="number" value="${product.importPrice || ''}" id="editImportPrice" style="width:100%"></td>
                    <td><input type="number" value="${product.salePrice || ''}" id="editSalePrice" style="width:100%"></td>
                    <td><input type="number" value="${product.discountPercent || ''}" id="editDiscountPercent" style="width:100%"></td>
                    <td><input type="number" value="${product.discountAmount || ''}" id="editDiscountAmount" style="width:100%"></td>
                    <td>
                        <button class="action-btn save" onclick="saveEdit(${idx})">Lưu</button>
                        <button class="action-btn cancel" onclick="cancelEdit()">Huỷ</button>
                    </td>
                `;
                // Xem trước ảnh khi chọn file mới
                setTimeout(() => {
                    const fileInput = document.getElementById(`editThumbnail${idx}`);
                    fileInput.onchange = function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function(ev) {
                                document.getElementById(`previewImg${idx}`).src = ev.target.result;
                            };
                            reader.readAsDataURL(file);
                        }
                    };
                }, 0);
            } else {
                tr.innerHTML = `
                    <td><img src="${thumbnail}" class="thumbnail" alt="Ảnh sản phẩm"></td>
                    <td>${product.name || ''}</td>
                    <td>${product.code || ''}</td>
                    <td>${product.importPrice || ''}</td>
                    <td>${product.salePrice || ''}</td>
                    <td>${product.discountPercent || ''}</td>
                    <td>${product.discountAmount || ''}</td>
                    <td>
                        <button class="action-btn edit" onclick="editProduct(${idx})">Sửa</button>
                        <button class="action-btn delete" onclick="deleteProduct(${idx})">Xoá</button>
                    </td>
                `;
            }
            tbody.appendChild(tr);
        });
    }
    window.editProduct = function(idx) {
        editingIndex = idx;
        renderProducts(filterProducts(document.getElementById('searchInput').value));
    }
    window.cancelEdit = function() {
        editingIndex = -1;
        renderProducts(filterProducts(document.getElementById('searchInput').value));
    }
    window.saveEdit = async function(idx) {
        const { ipcRenderer } = require('electron');
        const fs = require('fs');
        const path = require('path');
        const product = allProducts[idx];
        // Lấy giá trị, nếu rỗng hoặc không hợp lệ thì mặc định 0
        const discountPercentValue = parseFloat(document.getElementById('editDiscountPercent').value);
        const discountAmountValue = parseFloat(document.getElementById('editDiscountAmount').value);
        let thumbnailPath = product.thumbnail;
        const fileInput = document.getElementById(`editThumbnail${idx}`);
        if (fileInput && fileInput.files && fileInput.files[0]) {
            const file = fileInput.files[0];
            const imagesDir = path.join(__dirname, 'images');
            if (!fs.existsSync(imagesDir)) fs.mkdirSync(imagesDir);
            const destPath = path.join(imagesDir, file.name);
            fs.copyFileSync(file.path, destPath);
            thumbnailPath = `images/${file.name}`;
        }
        const updated = {
            ...product,
            name: document.getElementById('editName').value,
            code: document.getElementById('editCode').value,
            importPrice: parseFloat(document.getElementById('editImportPrice').value),
            salePrice: parseFloat(document.getElementById('editSalePrice').value),
            discountPercent: isNaN(discountPercentValue) ? 0 : discountPercentValue,
            discountAmount: isNaN(discountAmountValue) ? 0 : discountAmountValue,
            thumbnail: thumbnailPath
        };
        const response = await ipcRenderer.invoke('update-product', updated);
        if (response.success) {
            allProducts[idx] = updated;
            editingIndex = -1;
            renderProducts(filterProducts(document.getElementById('searchInput').value));
        } else {
            alert(response.message || 'Cập nhật thất bại!');
        }
    }
    window.deleteProduct = function(idx) {
        deleteIndex = idx;
        document.getElementById('deleteConfirmModal').style.display = 'flex';
    }
    document.getElementById('cancelDeleteBtn').onclick = function() {
        document.getElementById('deleteConfirmModal').style.display = 'none';
        deleteIndex = -1;
    }
    document.getElementById('confirmDeleteBtn').onclick = async function() {
        if (deleteIndex === -1) return;
        const { ipcRenderer } = require('electron');
        const product = allProducts[deleteIndex];
        const response = await ipcRenderer.invoke('delete-product', product.id);
        if (response.success) {
            allProducts.splice(deleteIndex, 1);
            renderProducts(filterProducts(document.getElementById('searchInput').value));
        } else {
            alert(response.message || 'Xoá thất bại!');
        }
        document.getElementById('deleteConfirmModal').style.display = 'none';
        deleteIndex = -1;
    }
    function filterProducts(keyword) {
        if (!keyword) return allProducts;
        const lower = keyword.toLowerCase();
        return allProducts.filter(p => (p.name || '').toLowerCase().includes(lower) || (p.code || '').toLowerCase().includes(lower));
    }
    document.getElementById('searchInput').addEventListener('input', function() {
        renderProducts(filterProducts(this.value));
    });
    fetchProducts();
    </script>
</body>
</html>
